{% extends 'core/base.html' %}
{% load static %}
{% block title %}–î–µ—à–±–æ—Ä–¥{% endblock %}
{% block content %}

<div class="container mt-4">
    <h1 class="mb-4">üìä –î–µ—à–±–æ—Ä–¥</h1>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <!-- –í–∏—Ç—Ä–∞—Ç–∏ -->
        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body">
                    <h6 class="card-title text-danger">–í–∏—Ç—Ä–∞—Ç–∏ (—Ç–∏–∂–¥–µ–Ω—å)</h6>
                    <h3 class="text-danger">-{{ week_expenses|floatformat:2 }} –≥—Ä–Ω</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-danger">
                <div class="card-body">
                    <h6 class="card-title text-danger">–í–∏—Ç—Ä–∞—Ç–∏ (–º—ñ—Å—è—Ü—å)</h6>
                    <h3 class="text-danger">-{{ month_expenses|floatformat:2 }} –≥—Ä–Ω</h3>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∏–±—É—Ç–∫–∏ -->
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="card-title text-success">–ü—Ä–∏–±—É—Ç–æ–∫ (—Ç–∏–∂–¥–µ–Ω—å)</h6>
                    <h3 class="text-success">+{{ week_income|floatformat:2 }} –≥—Ä–Ω</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="card-title text-success">–ü—Ä–∏–±—É—Ç–æ–∫ (–º—ñ—Å—è—Ü—å)</h6>
                    <h3 class="text-success">+{{ month_income|floatformat:2 }} –≥—Ä–Ω</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- –ë–∞–ª–∞–Ω—Å -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card {% if week_balance >= 0 %}border-success{% else %}border-warning{% endif %}">
                <div class="card-body">
                    <h5 class="card-title">–ë–∞–ª–∞–Ω—Å –∑–∞ —Ç–∏–∂–¥–µ–Ω—å</h5>
                    <h3 class="{% if week_balance >= 0 %}text-success{% else %}text-warning{% endif %}">
                        {% if week_balance >= 0 %}+{% endif %}{{ week_balance|floatformat:2 }} –≥—Ä–Ω
                    </h3>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card {% if month_balance >= 0 %}border-success{% else %}border-warning{% endif %}">
                <div class="card-body">
                    <h5 class="card-title">–ë–∞–ª–∞–Ω—Å –∑–∞ –º—ñ—Å—è—Ü—å</h5>
                    <h3 class="{% if month_balance >= 0 %}text-success{% else %}text-warning{% endif %}">
                        {% if month_balance >= 0 %}+{% endif %}{{ month_balance|floatformat:2 }} –≥—Ä–Ω
                    </h3>
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–µ—â–æ–¥–∞–≤–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–û—Å—Ç–∞–Ω–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>–¢–∏–ø</th>
                                    <th>–ù–∞–∑–≤–∞</th>
                                    <th>–°—É–º–∞</th>
                                    <th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
                                    <th>–ß–∞—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in last_transactions %}
                                <tr>
                                    <td>
                                        {% if t.transaction_type == 'income' %}
                                            <span class="badge bg-success">–ü—Ä–∏–±—É—Ç–æ–∫</span>
                                        {% else %}
                                            <span class="badge bg-danger">–í–∏—Ç—Ä–∞—Ç–∞</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ t.name }}</td>
                                    <td class="{% if t.transaction_type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                        {% if t.transaction_type == 'income' %}+{% else %}-{% endif %}{{ t.price }} –≥—Ä–Ω
                                    </td>
                                    <td>
                                        {% if t.category %}
                                            {{ t.category.icon }} {{ t.category.name }}
                                        {% else %}
                                            –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
                                        {% endif %}
                                    </td>
                                    <td>{{ t.created_at|date:"d.m H:i" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center">–ù–µ–º–∞—î —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ì—Ä–∞—Ñ—ñ–∫–∏ -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìä –ì—Ä–∞—Ñ—ñ–∫ –ø—Ä–∏–±—É—Ç–∫—ñ–≤ —Ç–∞ –≤–∏—Ç—Ä–∞—Ç</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìä –†–æ–∑–ø–æ–¥—ñ–ª –≤–∏—Ç—Ä–∞—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monthly income/expenses chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: {{ monthly_labels|safe }},
            datasets: [{
                label: '–í–∏—Ç—Ä–∞—Ç–∏ (–≥—Ä–Ω)',
                data: {{ monthly_expenses_data|safe }},
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            },
            {
                label: '–ü—Ä–∏–±—É—Ç–∫–∏ (–≥—Ä–Ω)',
                data: {{ monthly_income_data|safe }},
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Category pie chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'pie',
        data: {
            labels: {{ category_labels|safe }},
            datasets: [{
                data: {{ category_amounts|safe }},
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40',
                    '#FF6384',
                    '#C9CBCF'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
});
</script>

{% endblock %}